---
dir: 前端
dirIndex: 1
subDir: 拖拽
subDirIndex: 3
index: 10
title: react-dnd祖传代码兼容方案
description: react-dnd祖传代码兼容方案
author: 杨飞
tags: [前端, react, react-dnd, 拖拽, 祖传代码]
date: 2021-03-24 09:42:48
---

> 祖传项目中，react-dnd 通常存在以下问题：
> 
> 一、新老版本的语法差异比较大
> 
> 二、祖传代码的编写方法，可能特别复杂，完全不知道写的是什么鬼东西。
> 
> 三、维护祖传的react-dnd代码，通常令你无从下手，不知道那个傻叉当时为什么要那样写。
> 
> 四、@##@￥#%￥……%#&……&……%*&……（*……（……））

其实，react-dnd 祖传代码的解决方案还是比较简单的。

##### 一、删除node_modules文件夹和yarn.lock或npm的那个版本锁文件（不记得叫啥了。。。）

```shell
rm -rf node_modules  yarn.lock 
```

##### 二、安装新版本

```shell
yarn add react-dnd@14.0.2 react-dnd-html5-backend@14.0.0
```

##### 三、安装老版本

```shell
yarn add react-dnd254@npm:react-dnd@2.5.4  react-dnd-html5-backend254@npm:react-dnd-html5-backend@2.5.4
```

##### 四、修改不兼容的代码

```jsx
// 将不容就的老版本，改成指定的老版本名称
import { DragLayer } from 'react-dnd254';
```

##### 五、解决新组件拖拽时，奇怪背景的问题

如果不做特殊处理，那么新老版本的代码在一起，可能会出现老代码影响新代码拖拽预览的情况。

例如：

- 你命名没有做任何的拖拽预览配置，但是拖拽的时候，会有一些莫名其妙的样式。

> 这是因为，老代码中有统一的预览处理，所以你也必须将，你的预览融合到老代码中去。

检测老代码是否统一处理

```jsx
import { getEmptyImage } from 'react-dnd-html5-backend';

connectDragPreview(getEmptyImage(), {
  captureDraggingState: true,
});
```

是否有类似上面的代码配置，如果有，那么就是全局统一处理的预览，那么新代码的拖拽对象，也就是 sourceItem 也要加上这个配置。

具体的代码不能贴上来，但是，原理都是一样的。

- 拖拽对象组件， 先引入，然后在 connectDragSource 方法之前，加上 connectDragPreview 的代码即可。

- 配置你的拖拽组件，将传入拖拽对象的所有数据，在 beginDrag 方法里，都传给DND，这样渲染的时候，渲染组件就可以接收到了。

> 注意，额外新增一个组件识别的属性，例如: dragType: "新类型标识"

- 然后找到老代码的预览模块组件，(这个需要你自己找，每个项目都不一样)

> 在渲染的地方，进行判断。如果 dragType 属性的值为 "新类型标识"，那么就返回新的渲染方法。

  - 新的渲染方法
  > 将 被拖拽组件 的代码复制一份过来，删掉里面 DND的部分，只保留样式渲染的部分即可。

- 刷新页面，你就可以看到一个你预想的拖拽预览了，和你展示的时候，完全一致。

##### 六、备注

- 老版本代码，不用做任何的修改。

- 新版本代码，按新的语法规则写即可。实践下来，暂时没发现什么异常问题。

- 屎上雕花，无奈之举。。。

---- END -----
